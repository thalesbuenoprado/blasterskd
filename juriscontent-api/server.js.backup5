const express = require('express');
const cors = require('cors');
const { createCanvas, loadImage, registerFont } = require('canvas');
const cloudinary = require('cloudinary').v2;
const fs = require('fs');
const path = require('path');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3001;

const TRENDING_FILE = path.join(__dirname, 'trending-topics.json');

const allowedOrigins = process.env.ALLOWED_ORIGINS
  ? process.env.ALLOWED_ORIGINS.split(',')
  : ['http://localhost:5173', 'http://localhost:3000'];

app.use(cors({
  origin: function(origin, callback) {
    if (!origin) return callback(null, true);
    if (allowedOrigins.indexOf(origin) !== -1 || process.env.NODE_ENV !== 'production') {
      callback(null, true);
    } else {
      callback(new Error('NÃ£o permitido pelo CORS'));
    }
  },
  credentials: true
}));

app.use(express.json({ limit: '10mb' }));

cloudinary.config({
  cloud_name: process.env.CLOUDINARY_CLOUD_NAME || 'dgf3hzmb8',
  api_key: process.env.CLOUDINARY_API_KEY || '239768197523983',
  api_secret: process.env.CLOUDINARY_API_SECRET || 'PVPOJkaWTJcMIJn5Nsn-_h9BWJk'
});

app.get('/', (req, res) => {
  res.json({
    status: 'JurisContent Backend v2.0 - IA Integrada',
    environment: process.env.NODE_ENV || 'development',
    timestamp: new Date().toISOString()
  });
});

// ================================================
// FUNÃ‡Ã•ES AUXILIARES PARA CANVAS
// ================================================
function wrapText(ctx, text, maxWidth) {
  const words = text.split(' ');
  const lines = [];
  let currentLine = '';
  for (const word of words) {
    const testLine = currentLine ? currentLine + ' ' + word : word;
    const metrics = ctx.measureText(testLine);
    if (metrics.width > maxWidth && currentLine) {
      lines.push(currentLine);
      currentLine = word;
    } else {
      currentLine = testLine;
    }
  }
  if (currentLine) lines.push(currentLine);
  return lines;
}

function drawTextWithShadow(ctx, text, x, y, shadowColor = 'rgba(0,0,0,0.8)', shadowBlur = 10) {
  ctx.save();
  ctx.shadowColor = shadowColor;
  ctx.shadowBlur = shadowBlur;
  ctx.shadowOffsetX = 2;
  ctx.shadowOffsetY = 2;
  ctx.fillText(text, x, y);
  ctx.restore();
}

function drawDarkBox(ctx, x, y, width, height, radius = 20, opacity = 0.75) {
  ctx.save();
  ctx.fillStyle = `rgba(0, 0, 0, ${opacity})`;
  ctx.beginPath();
  ctx.roundRect(x, y, width, height, radius);
  ctx.fill();
  ctx.restore();
}

function drawMultilineText(ctx, lines, x, y, lineHeight, align = 'center') {
  ctx.textAlign = align;
  for (let i = 0; i < lines.length; i++) {
    drawTextWithShadow(ctx, lines[i], x, y + (i * lineHeight));
  }
}

// ================================================
// FUNÃ‡ÃƒO: Gerar conteÃºdo via IA (n8n)
// ================================================
async function gerarConteudoIA(texto, tema, area, template) {
  const prompts = {
    'voce-sabia': `VocÃª Ã© um especialista em marketing jurÃ­dico. Analise o conteÃºdo e crie um texto CURTO para Story do Instagram.

CONTEÃšDO ORIGINAL:
${texto}

TEMA: ${tema}
ÃREA: ${area}

REGRAS IMPORTANTES:
1. O campo "resposta" deve ter NO MÃXIMO 180 caracteres
2. A frase deve ser COMPLETA (terminar com ponto final)
3. Seja direto e profissional
4. NÃƒO repita "VocÃª sabia" na resposta

Retorne APENAS este JSON (sem markdown, sem explicaÃ§Ãµes):
{"pergunta":"${tema}","resposta":"TEXTO AQUI - mÃ¡x 180 caracteres, frase completa","destaque":"CONHEÃ‡A SEUS DIREITOS"}`,

    'bullets': `VocÃª Ã© um especialista em marketing jurÃ­dico. Crie um texto CURTO para Story do Instagram.

CONTEÃšDO: ${texto}
TEMA: ${tema}
ÃREA: ${area}

Retorne APENAS este JSON:
{"headline":"TÃ­tulo curto sobre ${tema}","bullets":["Ponto 1 curto","Ponto 2 curto","Ponto 3 curto"],"cta":"Salve este post!"}`,

    'estatistica': `VocÃª Ã© um especialista em marketing jurÃ­dico para Instagram Stories.

CONTEÃšDO ORIGINAL: ${texto}
TEMA: ${tema}
ÃREA: ${area}

INSTRUÃ‡Ã•ES:
1. NÃšMERO: Use estatÃ­stica REAL e VARIADA (nÃ£o sempre 80%). Pode ser: porcentagem (45%, 67%), valor (R$ 5.000), tempo (5 anos), quantidade (3 em cada 10)
2. CONTEXTO: Frase curta explicando o nÃºmero (5-8 palavras)
3. EXPLICAÃ‡ÃƒO: Texto informativo de 3-4 frases (250-350 caracteres). Explique o impacto, as consequÃªncias e o que o leitor deve saber.

Retorne APENAS este JSON:
{"headline":"TÃ­tulo impactante (8-12 palavras)","estatistica":{"numero":"DADO VARIADO","contexto":"O que representa (5-8 palavras)","explicacao":"Texto completo com 3-4 frases explicando o contexto, impacto e importÃ¢ncia. MÃ­nimo 250 caracteres. Seja informativo e direto."}}`,

    'urgente': `VocÃª Ã© um especialista em marketing jurÃ­dico para Instagram Stories de ALERTA.

CONTEÃšDO ORIGINAL: ${texto}
TEMA: ${tema}
ÃREA: ${area}

INSTRUÃ‡Ã•ES:
1. ALERTA: TÃ­tulo urgente e impactante (8-12 palavras) - use palavras como "ATENÃ‡ÃƒO", "CUIDADO", "URGENTE"
2. PRAZO: Se houver prazo especÃ­fico, coloque (ex: "30 dias", "AtÃ© dezembro", "5 anos"). Se nÃ£o houver, deixe vazio ""
3. RISCO: Explique as CONSEQUÃŠNCIAS de nÃ£o agir. Texto de 3-4 frases (200-300 caracteres). Seja especÃ­fico sobre o que a pessoa pode perder.
4. AÃ‡ÃƒO: O que fazer AGORA (frase imperativa curta, 8-10 palavras)

Retorne APENAS este JSON:
{"alerta":"ATENÃ‡ÃƒO: TÃ­tulo urgente sobre ${tema}","prazo":"Prazo especÃ­fico ou vazio","risco":"ConsequÃªncias detalhadas em 3-4 frases. Explique o que acontece se nÃ£o agir, quais direitos perde, qual o impacto financeiro. MÃ­nimo 200 caracteres.","acao":"Consulte um advogado especialista agora"}`,

    'premium': `VocÃª Ã© um especialista em marketing jurÃ­dico. Crie um texto CURTO para Story do Instagram.

CONTEÃšDO: ${texto}
TEMA: ${tema}
ÃREA: ${area}

REGRAS: O campo "insight" deve ter NO MÃXIMO 180 caracteres e ser uma frase COMPLETA.

Retorne APENAS este JSON:
{"headline":"TÃ­tulo elegante sobre ${tema}","insight":"TEXTO AQUI - mÃ¡x 180 caracteres, frase completa","conclusao":"ConclusÃ£o curta"}`
  };

  const prompt = prompts[template] || prompts['voce-sabia'];

  try {
    console.log('ðŸ¤– Chamando IA para template:', template);
    
    const response = await fetch('http://localhost:5678/webhook/juridico-working', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt })
    });

    if (!response.ok) {
      throw new Error(`N8N erro: ${response.status}`);
    }

    const data = await response.json();
    const textoIA = data.content || '';
    
    console.log('ðŸ“ Resposta IA:', textoIA.substring(0, 300));

    // Extrair JSON
    const jsonMatch = textoIA.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      const parsed = JSON.parse(jsonMatch[0]);
      console.log('âœ… JSON parseado:', JSON.stringify(parsed).substring(0, 200));
      return parsed;
    }
    
    throw new Error('JSON nÃ£o encontrado');
  } catch (error) {
    console.log('âš ï¸ Erro IA:', error.message);
    return null;
  }
}

// ================================================
// FUNÃ‡ÃƒO: Fallback quando IA falha
// ================================================
function criarFallback(template, texto, tema) {
  const textoLimpo = (texto || '').substring(0, 180);
  
  return {
    pergunta: tema || 'InformaÃ§Ã£o JurÃ­dica',
    resposta: textoLimpo,
    destaque: 'CONHEÃ‡A SEUS DIREITOS',
    headline: tema || 'InformaÃ§Ã£o JurÃ­dica',
    bullets: [],
    estatistica: { numero: '', contexto: '', explicacao: '' },
    cta: 'Siga para mais dicas'
  };
}

// ================================================
// ROTA: GERAR STORY (com IA integrada)
// ================================================
app.post('/api/gerar-story', async (req, res) => {
  try {
    const {
      texto,
      tema,
      area,
      template,
      perfil_visual,
      nome_advogado,
      oab,
      telefone,
      instagram,
      logo
    } = req.body;

    if (!template) {
      return res.status(400).json({ error: 'Template obrigatÃ³rio' });
    }

    console.log('ðŸ“± Gerando Story:', { template, area, tema, temLogo: !!logo });

    // 1. Tentar gerar conteÃºdo via IA
    let dadosProcessados = await gerarConteudoIA(texto, tema, area, template);
    
    // 2. Se falhar, usar fallback
    if (!dadosProcessados) {
      console.log('âš ï¸ Usando fallback');
      dadosProcessados = criarFallback(template, texto, tema);
    }

    // 3. Enviar para Puppeteer
    const PUPPETEER_URL = process.env.PUPPETEER_URL || 'http://localhost:3002/render-story';

    const storyData = {
      template,
      data: {
        corPrimaria: perfil_visual?.cor_primaria || '#1e3a5f',
        corSecundaria: perfil_visual?.cor_secundaria || '#d4af37',
        corFundo: perfil_visual?.cor_fundo || '#0d1b2a',
        nomeAdvogado: nome_advogado || '',
        oab: oab || '',
        telefone: telefone || '',
        instagram: instagram || '',
        iniciais: nome_advogado 
          ? nome_advogado.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() 
          : '',
        area: area || '',
        tema: tema || '',
        logo: logo || '',
        ...dadosProcessados
      }
    };

    console.log('ðŸŽ¨ Enviando para Puppeteer...');
    
    const response = await fetch(PUPPETEER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(storyData)
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Puppeteer erro: ${response.status} - ${errorText}`);
    }

    const data = await response.json();

    if (!data.success || !data.image) {
      throw new Error('Falha ao gerar imagem do Story');
    }

    console.log('ðŸ“¤ Upload para Cloudinary...');
    const uploadResult = await cloudinary.uploader.upload(data.image, {
      folder: 'juridico-stories',
      format: 'png'
    });

    console.log('âœ… Story gerado:', uploadResult.secure_url);

    res.json({
      success: true,
      imageUrl: uploadResult.secure_url,
      template: template,
      renderTimeMs: data.renderTimeMs
    });

  } catch (error) {
    console.error('âŒ Erro gerar story:', error);
    res.status(500).json({
      error: 'Erro ao gerar story',
      details: error.message
    });
  }
});

// ================================================
// ROTA: GERAR IMAGEM FEED
// ================================================
app.post('/api/gerar-imagem', async (req, res) => {
  try {
    const { 
      imageUrl, tema, area, nomeAdvogado, oab, instagram, formato, estilo, logo, bullets, conteudo
    } = req.body;

    if (!imageUrl) return res.status(400).json({ error: 'URL da imagem obrigatÃ³ria' });

    console.log('ðŸ–¼ï¸ Gerando imagem Feed:', { formato, estilo, area });

    const paletas = {
      classico: { text: '#FFFFFF', accent: '#D4AF37', dark: 'rgba(0,0,0,0.8)' },
      moderno: { text: '#FFFFFF', accent: '#FACC15', dark: 'rgba(15,23,42,0.85)' },
      executivo: { text: '#FFFFFF', accent: '#C9A050', dark: 'rgba(0,0,0,0.85)' },
      acolhedor: { text: '#FFFFFF', accent: '#FFB366', dark: 'rgba(30,20,10,0.8)' }
    };
    const cores = paletas[estilo] || paletas.classico;

    const dimensoes = {
      quadrado: { w: 1080, h: 1080 },
      stories: { w: 1080, h: 1920 },
      landscape: { w: 1200, h: 628 }
    };
    const dim = dimensoes[formato] || dimensoes.quadrado;

    const canvas = createCanvas(dim.w, dim.h);
    const ctx = canvas.getContext('2d');

    const baseImage = await loadImage(imageUrl);
    ctx.drawImage(baseImage, 0, 0, dim.w, dim.h);

    const paddingH = 60;
    const topoBoxY = 30;
    
    ctx.font = 'bold 42px Arial';
    const temaLines = wrapText(ctx, tema || '', dim.w - (paddingH * 2) - 40);
    const temaBoxHeight = Math.max(180, 80 + (temaLines.length * 50));
    
    drawDarkBox(ctx, paddingH, topoBoxY, dim.w - (paddingH * 2), temaBoxHeight, 20, 0.8);

    if (area) {
      ctx.fillStyle = cores.accent;
      ctx.font = 'bold 28px Arial';
      ctx.textAlign = 'center';
      drawTextWithShadow(ctx, area.toUpperCase(), dim.w / 2, topoBoxY + 45);
    }

    if (tema) {
      ctx.fillStyle = cores.text;
      ctx.font = 'bold 42px Georgia';
      const startY = topoBoxY + 90;
      drawMultilineText(ctx, temaLines, dim.w / 2, startY, 50, 'center');
    }

    const rodapeBoxHeight = 140;
    const rodapeBoxY = dim.h - rodapeBoxHeight - 30;
    
    drawDarkBox(ctx, paddingH, rodapeBoxY, dim.w - (paddingH * 2), rodapeBoxHeight, 20, 0.8);

    if (nomeAdvogado) {
      ctx.fillStyle = cores.accent;
      ctx.font = 'bold 36px Arial';
      ctx.textAlign = 'center';
      drawTextWithShadow(ctx, nomeAdvogado, dim.w / 2, rodapeBoxY + 55);
    }

    if (oab) {
      ctx.fillStyle = cores.text;
      ctx.font = '26px Arial';
      ctx.textAlign = 'center';
      drawTextWithShadow(ctx, oab, dim.w / 2, rodapeBoxY + 100);
    }

    const bulletsArray = bullets || conteudo?.bullets || [];
    
    if (bulletsArray.length > 0) {
      const bulletBoxY = temaBoxHeight + topoBoxY + 40;
      const bulletBoxHeight = Math.min(bulletsArray.length * 70 + 60, dim.h - bulletBoxY - rodapeBoxHeight - 100);
      
      drawDarkBox(ctx, paddingH, bulletBoxY, dim.w - (paddingH * 2), bulletBoxHeight, 20, 0.75);
      
      ctx.fillStyle = cores.text;
      ctx.font = '32px Arial';
      ctx.textAlign = 'left';
      
      const bulletStartY = bulletBoxY + 50;
      const bulletX = paddingH + 40;
      
      bulletsArray.slice(0, 5).forEach((bullet, index) => {
        const bulletText = typeof bullet === 'string' ? bullet : bullet.texto || bullet.titulo || '';
        const y = bulletStartY + (index * 65);
        
        ctx.fillStyle = cores.accent;
        drawTextWithShadow(ctx, 'âœ“', bulletX, y);
        
        ctx.fillStyle = cores.text;
        const bulletLines = wrapText(ctx, bulletText, dim.w - (paddingH * 2) - 100);
        drawTextWithShadow(ctx, bulletLines[0] || '', bulletX + 40, y);
      });
    }

    if (logo) {
      try {
        const logoBase64 = logo.startsWith('data:') ? logo : `data:image/png;base64,${logo}`;
        const logoImage = await loadImage(logoBase64);
        
        const logoX = dim.w - 110;
        const logoY = 40;
        const logoSize = 70;
        
        ctx.save();
        ctx.beginPath();
        ctx.arc(logoX + logoSize/2, logoY + logoSize/2, logoSize/2 + 5, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(0,0,0,0.6)';
        ctx.fill();
        ctx.restore();
        
        ctx.drawImage(logoImage, logoX, logoY, logoSize, logoSize);
      } catch (e) {
        console.log('âš ï¸ Erro logo:', e.message);
      }
    }

    const imageBuffer = canvas.toBuffer('image/jpeg', { quality: 0.95 });
    const base64Image = `data:image/jpeg;base64,${imageBuffer.toString('base64')}`;

    const uploadResult = await cloudinary.uploader.upload(base64Image, {
      folder: 'juridico-final',
      format: 'jpg'
    });

    console.log('âœ… Imagem Feed gerada:', uploadResult.secure_url);
    res.json({ success: true, imageUrl: uploadResult.secure_url });
  } catch (error) {
    console.error('âŒ Erro imagem:', error);
    res.status(500).json({ error: 'Erro ao gerar imagem', details: error.message });
  }
});

// ================================================
// OUTRAS ROTAS
// ================================================
app.post('/api/trending-topics', (req, res) => {
  try {
    const { trending, dataAtualizacao } = req.body;
    if (!trending || !Array.isArray(trending)) {
      return res.status(400).json({ error: 'Dados invÃ¡lidos' });
    }
    const dados = {
      trending: trending.slice(0, 3),
      dataAtualizacao: dataAtualizacao || new Date().toISOString(),
      ultimaAtualizacao: new Date().toISOString()
    };
    fs.writeFileSync(TRENDING_FILE, JSON.stringify(dados, null, 2));
    res.json({ success: true, count: dados.trending.length });
  } catch (error) {
    res.status(500).json({ error: 'Erro trending', details: error.message });
  }
});

app.get('/api/trending-topics', (req, res) => {
  try {
    if (fs.existsSync(TRENDING_FILE)) {
      const dados = JSON.parse(fs.readFileSync(TRENDING_FILE, 'utf-8'));
      return res.json(dados);
    }
    res.json({
      trending: [
        { tema: "Direitos do Consumidor", descricao: "Novas regras", area: "Consumidor", icone: "ðŸ›’" },
        { tema: "Reforma Trabalhista", descricao: "Impactos", area: "Trabalhista", icone: "ðŸ’¼" },
        { tema: "LGPD", descricao: "ProteÃ§Ã£o de dados", area: "Digital", icone: "ðŸ”" }
      ],
      isFallback: true
    });
  } catch (error) {
    res.status(500).json({ error: 'Erro trending' });
  }
});

app.post('/api/analisar-logo', async (req, res) => {
  try {
    const { logo } = req.body;
    if (!logo) return res.status(400).json({ error: 'Logo obrigatÃ³ria' });
    const response = await fetch('http://localhost:5678/webhook/analisar-logo-v2', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ logo })
    });
    if (!response.ok) throw new Error(`N8N erro: ${response.status}`);
    const data = await response.json();
    res.json(data);
  } catch (error) {
    res.status(500).json({ error: 'Erro logo', details: error.message });
  }
});

app.post('/api/gerar-conteudo', async (req, res) => {
  try {
    const { prompt } = req.body;
    if (!prompt) return res.status(400).json({ error: 'Prompt obrigatÃ³rio' });
    const response = await fetch('http://localhost:5678/webhook/juridico-working', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt })
    });
    if (!response.ok) throw new Error(`N8N erro: ${response.status}`);
    const data = await response.json();
    res.json({ content: data.content || data.texto || '' });
  } catch (error) {
    res.status(500).json({ error: 'Erro conteÃºdo', details: error.message });
  }
});

app.post('/api/gerar-prompt-imagem', async (req, res) => {
  try {
    const { tema, area, estilo, formato, texto, perfil_visual } = req.body;
    const response = await fetch('http://localhost:5678/webhook/juridico-hibrido', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tema, area, estilo, formato, texto, perfil_visual })
    });
    if (!response.ok) throw new Error(`N8N erro: ${response.status}`);
    const data = await response.json();
    res.json(data);
  } catch (error) {
    res.status(500).json({ error: 'Erro prompt', details: error.message });
  }
});

app.post('/api/remover-fundo', async (req, res) => {
  try {
    let { logo } = req.body;
    if (!logo) return res.status(400).json({ success: false, error: 'Logo nÃ£o fornecida' });
    if (logo.includes(',')) logo = logo.split(',')[1];

    const https = require('https');
    const querystring = require('querystring');

    const postData = querystring.stringify({
      image_file_b64: logo,
      size: 'auto',
      format: 'png'
    });

    const options = {
      hostname: 'api.remove.bg',
      path: '/v1.0/removebg',
      method: 'POST',
      headers: {
        'X-Api-Key': process.env.REMOVEBG_API_KEY || 'cz67CSF3ZrSWHxhXuvWzVgTz',
        'Content-Type': 'application/x-www-form-urlencoded',
        'Content-Length': Buffer.byteLength(postData)
      }
    };

    const apiRequest = https.request(options, (apiResponse) => {
      const chunks = [];
      apiResponse.on('data', (chunk) => chunks.push(chunk));
      apiResponse.on('end', () => {
        const buffer = Buffer.concat(chunks);
        if (apiResponse.statusCode === 200) {
          res.json({ success: true, logoSemFundo: buffer.toString('base64'), mimeType: 'image/png' });
        } else {
          res.status(apiResponse.statusCode).json({ success: false, error: 'Erro API' });
        }
      });
    });

    apiRequest.on('error', (error) => res.status(500).json({ success: false, error: error.message }));
    apiRequest.write(postData);
    apiRequest.end();
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});

const http = require("http");

app.all("/api/n8n/*", (req, res) => {
  const n8nPath = req.path.replace("/api/n8n", "");
  const options = {
    hostname: "localhost",
    port: 5678,
    path: n8nPath,
    method: req.method,
    headers: { "Content-Type": "application/json" }
  };

  const proxyReq = http.request(options, (proxyRes) => {
    res.status(proxyRes.statusCode);
    proxyRes.pipe(res);
  });

  proxyReq.on("error", () => res.status(500).json({ error: "Erro n8n" }));
  if (["POST", "PUT", "PATCH"].includes(req.method) && req.body) {
    proxyReq.write(JSON.stringify(req.body));
  }
  proxyReq.end();
});

app.listen(PORT, () => {
  console.log('=================================');
  console.log('ðŸš€ Backend v2.0 - IA Integrada');
  console.log('=================================');
  console.log('âœ… Porta:', PORT);
  console.log('ðŸ¤– IA: ATIVA para Stories');
  console.log('ðŸ“± Stories: Textos otimizados');
  console.log('=================================');
});
